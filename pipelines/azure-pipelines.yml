# ASP.NET Core
# Build and test ASP.NET Core projects targeting .NET Core.
# Add steps that run tests, create a NuGet package, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/dotnet-core

trigger:
- master

variables:
  buildConfiguration: 'Release'
  spaName: sample-spa
  azureServiceEndpoint: 'Nebbia - Partner Network(1979771a-9163-4750-8947-e6dbe596a8d7)'

stages: 
- stage: stage_build
  displayName: "Build"
  jobs: 
  - job: job_build_all
    displayName: "Build MVC & SPA"
    pool: 
      vmImage: 'ubuntu-latest'
    steps:
    - script: dotnet build --configuration $(buildConfiguration) -o $(Build.ArtifactStagingDirectory)/mvc
      displayName: 'dotnet build $(buildConfiguration)'
      workingDirectory: ./mvc
    - script: |
        echo "installing NPM packages and building"
        npm install
        npm run build

        cd build 
        echo "creating the spa folder on artifacts staging directory"
        mkdir -p $(Build.ArtifactStagingDirectory)/spa
        echo "copying files to artifacts staging directory"
        cp -vR * $(Build.ArtifactStagingDirectory)/spa
      displayName: 'npm run build'
      workingDirectory: ./spa/$(spaName)
    - script: cp -vR ./arm $(Build.ArtifactStagingDirectory)/arm
      displayName: "Copying arm templates to artifacts staging directory"
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)'
        ArtifactName: 'drop'
        publishLocation: 'Container'
    
- stage: stage_deploy_dev
  displayName: "Deploy to dev"
  dependsOn: stage_build
  variables:
    environment: dev
    spaNameNoDashes: sampleapp
    blobStorageName: devsampleapp01
    cdnEndpointName: endpoint-sampleapp
    cdnProfileName: sampleapp-profile
    resourceGroup: $(environment)-$(spaNameNoDashes)-rg
  jobs: 
  - job: job_deploy_azure
    displayName: "Deploy to CDN"
    pool:
      vmImage: 'windows-latest'
    steps: 
    - download: current
      artifact: drop
    - task: AzureResourceGroupDeployment@2
      displayName: Deploy ARM Template to Create CDN
      inputs:
        azureSubscription: $(azureServiceEndpoint)
        action: 'Create Or Update Resource Group'
        resourceGroupName: $(resourceGroup)
        location: 'East US'
        templateLocation: 'Linked artifact'
        csmFile: '$(Pipeline.Workspace)/drop/arm/cdn-blob.json'
        overrideParameters: '-environment $(environment) -appName $(spaNameNoDashes)'
        deploymentMode: 'Incremental'
    - task: AzureFileCopy@2
      displayName: 'AzureBlob File Copy'
      inputs:
        sourcePath: '$(Pipeline.Workspace)/drop/spa'
        azureSubscription: $(azureServiceEndpoint)
        destination: AzureBlob
        storage: $(blobStorageName)
        containerName: '$(spaNameNoDashes)'
    - task: fabienlavocat.FabienLavocat-PurgeAzureCDNEndpoint.PurgeAzureCDNEndpoint.PurgeAzureCDNEndpoint@2
      displayName: 'Purge Azure CDN Endpoint'
      inputs:
        connectedServiceNameSelector: ConnectedServiceNameARM
        connectedServiceNameARM: $(azureServiceEndpoint)
        resourceGroupName: $(resourceGroup)
        endpointName: $(cdnEndpointName)
        profileName: $(cdnProfileName)
        purgeContent: /

  - job: deploy_webapp
    dependsOn: job_deploy_azure
    displayName: "Deploy to Website"
    pool:
      vmImage: 'windows-latest'
    steps: 
    - script: echo deploying to webapp